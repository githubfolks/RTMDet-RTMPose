# ==============================================================================
# RTMDet Training Configuration (MPS-Safe, NaN-Stable)
# Target: Mac Pro M5 | 24 GB RAM | Apple MPS
# ==============================================================================

detection:
  model:
    architecture: "RTMDet-s"
    input_size: [640, 640]

  data:
    root: "dataset_coco"
    train_images: "train/images"
    train_annotations: "train/train.json"

    # ðŸ”’ Smaller batch = more stable on MPS
    batch_size: 8

    # MPS does not benefit from many workers
    num_workers: 2
    pin_memory: false
    persistent_workers: false

  training:
    epochs: 200
    device: "cuda"
    work_dir: "train/weights_rtmdet_s_scratch"
    resume: false
    resume_from: null

    # ðŸ”’ Stabilization controls (Disabled for CUDA/Scratch)
    freeze_backbone: false
    freeze_at_epoch: 0

  optimization:
    # ðŸ”’ AdamW is unstable on MPS â†’ switch to SGD
    optimizer: "SGD"

    learning_rate:
      base_lr: 5.0e-3     # SGD-friendly LR
      warmup_steps: 2000
      scheduler: "CosineAnnealing"

    momentum: 0.9
    weight_decay: 5.0e-4

    # ðŸ”’ Stronger clipping (very important)
    gradient_clipping: 0.5

  augmentation:
    # ðŸ”’ Disable unstable augmentations on MPS
    mosaic_prob: 0.0
    mixup_prob: 0.0
    random_affine: false

  runtime:
    # ðŸ”’ Determinism helps reduce NaNs
    cudnn_benchmark: false
    cudnn_deterministic: true
